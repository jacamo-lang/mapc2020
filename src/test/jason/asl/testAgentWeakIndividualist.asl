/**
 * Test goals for agent Weak Individualist
 */

{ include("agentWeakIndividualist.asl") }
{ include("$jasonJar/test/jason/inc/tester_agent.asl") }

step(500).
gps_map(-12,-6,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-7,-35,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-7,-18,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-7,-17,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-6,-19,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-6,-18,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-6,-17,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-6,-16,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-5,-19,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-5,-18,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-5,-17,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-5,-16,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-4,-29,b2,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-4,-18,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-4,-17,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-3,6,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-3,7,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-2,-32,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-2,5,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-2,6,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-2,7,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-1,-32,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-1,4,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-1,5,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-1,6,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(-1,7,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(0,4,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(0,5,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(0,6,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(0,7,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(1,4,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(1,5,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(1,6,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(1,7,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(2,5,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(2,6,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(2,7,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(3,-15,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(3,-14,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(4,-16,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(4,-15,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(4,-14,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(4,-13,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(5,-16,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(5,-15,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(5,-14,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(5,-13,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(5,2,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(5,3,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(6,-30,b1,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(6,-15,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(6,-14,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(6,-7,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(6,-4,b2,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(6,1,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(6,2,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(6,3,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(6,4,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(7,-36,b1,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(7,-15,b0,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(7,-11,b2,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(7,1,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(7,2,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(7,3,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(7,4,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(8,2,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(8,3,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(9,2,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(10,-32,b0,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(10,-6,taskboard,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(10,1,obstacle,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(18,-26,goal,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(19,-27,goal,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(19,-26,goal,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(19,-25,goal,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(20,-28,goal,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(20,-27,goal,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(20,-26,goal,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
gps_map(20,-25,goal,"agenta0")[artifact_id(cobj_5),artifact_name(cobj_5,artGPSa0),percept_type(obs_prop),source(percept),workspace(cobj_5,enva,cobj_2)].
vision(5).
/*
 * Test if the agent got the right rotation
 */
@testSetRightPosition[atomic,test]
+!testSetRightPosition
    <-
    /**
     * Add mock plan for !do(rotate(D)) since it needs external library
     */
    .add_plan({ +!do(rotate(D),success) :
        attached(I,J) & rotate(D,I,J,II,JJ)
        <-
        -+attached(II,JJ);
    }, self, begin);

    /**
     * Perform tests
     */
    +attached(0,1); // I have a block at 6 o'clock
    !setRightPosition(req(0,1,tstB));  // The block must be at 6 o'clock
    !assert_true(attached(0,1));
    !setRightPosition(req(-1,0,tstB)); // The block must be at 9 o'clock
    !assert_true(attached(-1,0));
    !setRightPosition(req(1,0,tstB));  // The block must be at 3 o'clock
    !assert_true(attached(1,0));
    !setRightPosition(req(0,-1,tstB)); // The block must be at 12 o'clock
    .log(warning,"TODO: Fix testSetRightPosition");
    //!assert_true(attached(0,-1));
.

/**
 * Test got new task
 */
 //@testGotNewTask[test]
 +!testGotNewTask
    <-
    .log(warning,"TODO: Fix testGotNewTask");

    .abolish(accepted(_));
    .abolish(myposition(_,_));
    .abolish(attached(_,_));
    .abolish(gps_map(_,_,_,_));
    .abolish(task(_,_,_,_));
    .abolish(thing(_,_,_,_));
    +step(450);             // Give enough steps in order to be feasible in the deadline
    -+myposition(0,0);
    +gps_map(10,10,taskboard,_);            // I know a taskboard position
    +gps_map(15,15,b2,_);
    +gps_map(20,20,goal,_);                 // I know a goal area position
    +goal(0,0);                         // To submit a task it has to be on a goal area

    /**
     * Mock plan to goto since it uses external lib
     */
    .add_plan({ +!goto(X,Y) : step(S)
        <-
        -+step(S+1);
        -+myposition(X,Y);
        if (not thing(1,0,taskboard,_)) {
            +thing(1,0,taskboard,_);    // this on the first call of goto
        } if (not thing(1,0,dispenser,b2)) {
            +thing(1,0,dispenser,b2);   // only do this on the second call of goto
        }
    }, self, begin);

    /**
     * Add mock plan for !do(A) since it needs external library
     */
    .add_plan({ +!do(A,success) <- .print("mock ",A) }, self, begin);
    .add_plan({ +!do(attach(D),success) : directionIncrement(D,I,J) <-
        .print("mock ",attach(B));
        +attached(I,J);
    }, self, begin);

    /**
     * Add mock plan for !do(rotate(D)) since it needs external library
     */
    .add_plan({ +!do(rotate(D),success) :
        attached(I,J) & rotate(D,I,J,II,JJ)
        <-
        .print("mock ",rotate(D));
        -+attached(II,JJ);
    }, self, begin);

    +task(task22,503,1,[req(0,1,b2)]);
.


@[test]
+!test_goto :
    .findall(I,gps_map(I,J,O,_),LI) &
    .min(LI,MIN_I) // MIN_I informs the more negative I to know how far is from zero
    <-
    makeArtifact("rp_test_weakind", "localPositionSystem.rp.rp", [70,0], RpId);
    focus(RpId);
    for ( gps_map(I,J,O,MapId) ) {
        setGpsMapForTests(I,J,O,MapId)[artifact_id(RpId)];
    }

    .add_plan({
        +!do(move(DIR),success) :
            myposition(OX,OY) &
            directionIncrement(DIR,I,J) &
            walked_steps(S)
            <-
            -+walked_steps(S+1);
            !update_line(OX,OY,MIN_I,DIR);
    }, self, begin);

    !build_map(MIN_I);

    !test_goto_nearest_objects(MIN_I);
.

/**
 * Expected output
[testAgentWeakIndividualist]                               @gg                                                         -26
[testAgentWeakIndividualist]                               ^gg                                                         -25
[testAgentWeakIndividualist]                            >>>^                                                           -24
[testAgentWeakIndividualist]                        >>>>^                                                              -23
[testAgentWeakIndividualist]                        ^                                                                  -22
[testAgentWeakIndividualist]                        ^                                                                  -21
[testAgentWeakIndividualist]                     >>>^                                                                  -20
[testAgentWeakIndividualist]       ##            ^                                                                     -19
[testAgentWeakIndividualist]      ####           ^                                                                     -18
[testAgentWeakIndividualist]      ####           ^                                                                     -17
[testAgentWeakIndividualist]       ##        ##  ^                                                                     -16
[testAgentWeakIndividualist]                ####0^                                                                     -15
[testAgentWeakIndividualist]                ####D^                                                                     -14
[testAgentWeakIndividualist]                 ## v^                                                                     -13
[testAgentWeakIndividualist]                    R^                                                                     -12
[testAgentWeakIndividualist]                    ^<<                                                                    -11
[testAgentWeakIndividualist]                      ^                                                                    -10
[testAgentWeakIndividualist]                      ^                                                                    -9
[testAgentWeakIndividualist]                      ^                                                                    -8
[testAgentWeakIndividualist]                   #  ^                                                                    -7
[testAgentWeakIndividualist] #                    Ut                                                                   -6
[testAgentWeakIndividualist]                      ^                                                                    -5
[testAgentWeakIndividualist]                   >>>^                                                                    -4
[testAgentWeakIndividualist]                  >^                                                                       -3
[testAgentWeakIndividualist]                  ^                                                                        -2
[testAgentWeakIndividualist]                  ^                                                                        -1
[testAgentWeakIndividualist]             R>>>>^                                                                        0

*/
+!test_goto_nearest_objects(MIN_I)
    <-
    // Go from 0,0 to 20,12: min_distance = 32 steps

    ?nearest(taskboard,X1,Y1);
    ?nearest_neighbour(X1,Y1,X_1,Y_1);
    !check_performance(test_goto(0,0,X_1,Y_1,MIN_I,R0_1,R1_1,_),1,_);
    !assert_equals(15,R0_1);
    !assert_equals(15,R1_1);

    ?nearest(b0,X2,Y2);
    ?nearest_neighbour(X2,Y2,X_2,Y_2);
    !check_performance(test_goto(X_1,Y_1,X_2,Y_2,MIN_I,R0_2,R1_2,_),1,_);
    !assert_equals(10,R0_2);
    !assert_equals(10,R1_2);

    ?nearest(b2,X3,Y3);
    ?nearest_neighbour(X3,Y3,X_3,Y_3);
    !check_performance(test_goto(X_2,Y_2,X_3,Y_3,MIN_I,R0_3,R1_3,_),1,_);
    !assert_equals(2,R0_3);
    !assert_equals(2,R1_3);

    ?nearest(goal,X_4,Y_4);
    !check_performance(test_goto(X_3,Y_3,X_4,Y_4,MIN_I,R0_4,R1_4,_),1,_);
    !assert_equals(25,R0_4);
    !assert_equals(25,R1_4);

    !print_map;
.

+!test_goto(X0,Y0,X1,Y1,MIN_I,R0,R1,R2)
    <-
    -+myposition(X0,Y0);
    !update_line(X0,Y0,MIN_I,"H");
    -+walked_steps(0);
    !goto(X1,Y1,false,R2);
    !update_line(X1,Y1,MIN_I,"@");
    ?distance(X0,Y0,X1,Y1,R0);
    ?walked_steps(R1);
.

+!build_map(MIN_I)
    <-
    .findall(J,gps_map(I,J,O,_),LJ);
    .min(LJ,MIN_J);
    .max(LJ,MAX_J);
    //.log(info,"i:",MIN_I,":",MAX_I);
    //.log(info,"j:",MIN_J,":",MAX_J);
    for ( .range(J,MIN_J-50,MAX_J+50) ) {
        .concat("                                                                                          ",J,C);
        +line(J,C);
    }
    for ( gps_map(I,J,O,_) ) {
        !update_line(I,J,MIN_I,O);
    }
.

+!update_line(I,J,MIN_I,O) :
    line(J,L)
    <-
    -line(J,L);
    .substring( L, R0, 0, I - MIN_I);
    //.log(info,gps_map(I,J,O,_),":",I - MIN_I,":'",R0,"'");
    .length(L,LL);
    .substring( L, R1, I - MIN_I + 1, LL);
    .substring( L, OLD, I - MIN_I, I - MIN_I + 1);
    //.log(info,gps_map(I,J,O,_),":",I + 1 - MIN_I,":",LL,":",R1);
    if (.member(O,[b0,b1,b2])) {
        // If it is a dispenser just print the block identification
        .substring(O,R,1,2);
        .concat(R0,R,R1,RF);

    } else {
        if (O == obstacle) {
            .concat(R0,"#",R1,RF);
        } elif (O == s) {
            if (OLD \== "@" & OLD \== "H") {
                .concat(R0,"v",R1,RF);
            } else {
                .concat(R0,"D",R1,RF);
            }
        } elif (O == n) {
            if (OLD \== "@" & OLD \== "H") {
                .concat(R0,"^",R1,RF);
            } else {
                .concat(R0,"U",R1,RF);
            }
        } elif (O == e) {
            if (OLD \== "@" & OLD \== "H") {
                .concat(R0,">",R1,RF);
            } else {
                .concat(R0,"R",R1,RF);
            }
        } elif (O == w) {
            if (OLD \== "@" & OLD \== "H") {
                .concat(R0,"<",R1,RF);
            } else {
                .concat(R0,"L",R1,RF);
            }
        } else {
            // For other objects print the first letter
            .substring(O,R,0,1);
            .concat(R0,R,R1,RF);
        }
    }
    +line(J,RF);
.

+!print_map :
    .findall(J,gps_map(I,J,O,_),LJ) &
    .min(LJ,MIN_J) &
    .max(LJ,MAX_J)
    <-
    for ( .range(J,MIN_J,MAX_J) ) {
        ?line(J,RF);
        .log(info,RF);
    }
.
